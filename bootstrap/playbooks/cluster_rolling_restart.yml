---
- name: Rolling Restart of k3s Cluster
  hosts: k3s_cluster
  gather_facts: no
  become: no

  vars:
    maintenance_operation: rolling_restart
    rolling_restart_batch_size: 1
    rolling_restart_delay: 30
    rolling_restart_wait_ready: true

  pre_tasks:
    - name: Display rolling restart configuration
      debug:
        msg: |
          Rolling Restart Configuration:
          - Batch size: {{ rolling_restart_batch_size }} VM(s) at a time
          - Delay between batches: {{ rolling_restart_delay }} seconds
          - Wait for nodes to be ready: {{ rolling_restart_wait_ready }}

    - name: Confirm proceeding with rolling restart
      pause:
        prompt: "Press ENTER to continue with rolling restart or CTRL+C to cancel"

  roles:
    - cluster_maintenance

  post_tasks:
    - name: Final health check
      shell: |
        kubectl get nodes -o wide
        echo "---"
        kubectl get pods -A --no-headers | head -20
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      delegate_to: "{{ groups['k3s_cluster'][0] }}"
      register: health_check

    - name: Display health check results
      debug:
        msg: "{{ health_check.stdout }}"
