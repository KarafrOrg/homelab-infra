---
- name: Create VMs and bootstrap k3s cluster
  hosts: dedicated_servers
  gather_facts: yes
  become: no
  vars:
    vms_per_host: 3

  pre_tasks:
    - name: Validate and set vms_per_host variable
      set_fact:
        vms_per_host: "{{ vms_per_host | default(3) | int }}"
      run_once: yes

    - name: Debug vms_per_host before role
      debug:
        msg: "vms_per_host is set to: {{ vms_per_host }}"
      run_once: yes

  tasks:
    - name: Create VMs on dedicated servers
      import_role:
        name: create_vms

    - name: Wait for VM inventory to be populated
      pause:
        seconds: 10

    - name: Refresh inventory
      meta: refresh_inventory

- name: Bootstrap k3s cluster on VMs
  hosts: k3s_cluster
  gather_facts: yes
  become: no

  pre_tasks:
    - name: Wait for all hosts to be ready
      wait_for_connection:
        delay: 10
        timeout: 300

  roles:
    - bootstrap_k3s

  post_tasks:
    - name: Display cluster information
      debug:
        msg: |
          K3s cluster bootstrap completed!
          Kubeconfig saved to: ./kubeconfig-{{ k3s_cluster_name }}
          
          To access the cluster:
          export KUBECONFIG=./kubeconfig-{{ k3s_cluster_name }}
          kubectl get nodes
