---
- name: Create VMs and Bootstrap k3s Cluster
  hosts: dedicated_servers
  gather_facts: yes
  become: no

  tasks:
    - name: Create VMs on dedicated servers
      include_role:
        name: create_vms
      vars:
        vms_per_host: 3

    - name: Wait for VM inventory to be populated
      pause:
        seconds: 10

    - name: Refresh inventory
      meta: refresh_inventory

- name: Bootstrap k3s cluster on VMs
  hosts: k3s_cluster
  gather_facts: yes
  become: no

  pre_tasks:
    - name: Wait for all hosts to be ready
      wait_for_connection:
        delay: 10
        timeout: 300

  roles:
    - bootstrap_k3s

  post_tasks:
    - name: Display cluster information
      debug:
        msg: |
          K3s cluster bootstrap completed!
          Kubeconfig saved to: ./kubeconfig-{{ k3s_cluster_name }}
          
          To access the cluster:
          export KUBECONFIG=./kubeconfig-{{ k3s_cluster_name }}
          kubectl get nodes
