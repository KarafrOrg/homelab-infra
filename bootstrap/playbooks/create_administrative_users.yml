- name: Create administrative users for Ansible
  hosts: all
  become: yes
  vars:
    admin_users:
      - name: ansible
        shell: /bin/bash
        ssh_key: "{{ ansible_user_public_key }}"
        passwordless_sudo: true

  tasks:
    - name: Ensure admin group exists
      group:
        name: admin
        state: present

    - name: Create admin users
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: "{{ item.shell | default('/bin/bash') }}"
        groups: admin
        append: yes
        create_home: yes
      loop: "{{ admin_users }}"

    - name: Set authorized keys for admin users
      ansible.posix.authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.ssh_key }}"
        state: present
      loop: "{{ admin_users }}"

    - name: Allow admin users passwordless sudo
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ item.name }}"
        content: "{{ item.name }} ALL=(ALL) NOPASSWD:ALL"
        mode: '0440'
      when: item.passwordless_sudo | default(false)
      loop: "{{ admin_users }}"