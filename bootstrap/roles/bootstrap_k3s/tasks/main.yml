- name: Update system packages
  apt:
    update_cache: yes
    upgrade: dist
  become: yes

- name: Install required packages for k3s
  package:
    name: "{{ item }}"
    state: present
  become: yes
  loop:
    - curl
    - wget
    - ca-certificates
    - apt-transport-https
    - software-properties-common

- name: Generate k3s token if not exists
  set_fact:
    k3s_token: "{{ lookup('password', '/tmp/k3s_token_{{ k3s_cluster_name }} length=48 chars=ascii_letters,digits') }}"
  when: k3s_token is not defined or k3s_token == ""

- name: Determine k3s master nodes
  set_fact:
    k3s_masters: "{{ groups['k3s_cluster'] | select('search', 'node-.*-1$') | list }}"

- name: Debug k3s masters
  debug:
    msg: "K3s masters: {{ k3s_masters }}"

- name: Bootstrap k3s on first master
  block:
    - name: Download k3s installer
      get_url:
        url: "https://get.k3s.io"
        dest: "/tmp/k3s-install.sh"
        mode: '0755'

    - name: Install k3s server on first master
      shell: |
        K3S_TOKEN={{ k3s_token }} \
        K3S_KUBECONFIG_MODE="644" \
        /tmp/k3s-install.sh server \
        {{ k3s_server_args }}
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version if k3s_version != 'latest' else '' }}"
        INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
      become: yes

    - name: Wait for k3s server to be ready
      wait_for:
        path: "/etc/rancher/k3s/k3s.yaml"
        timeout: 120

    - name: Get k3s token from first master
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token
      become: yes

    - name: Set k3s node token fact
      set_fact:
        k3s_node_token_value: "{{ k3s_node_token['content'] | b64decode | trim }}"

  when: inventory_hostname == k3s_masters[0]

- name: Get kubeconfig from first master
  block:
    - name: Fetch kubeconfig
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "./kubeconfig-{{ k3s_cluster_name }}"
        flat: yes
      become: yes

    - name: Update kubeconfig with API server IP
      replace:
        path: "./kubeconfig-{{ k3s_cluster_name }}"
        regexp: "https://127.0.0.1:6443"
        replace: "https://{{ hostvars[k3s_masters[0]]['ansible_host'] }}:6443"
      delegate_to: localhost

  when: inventory_hostname == k3s_masters[0]

- name: Bootstrap k3s on master nodes (not first)
  block:
    - name: Download k3s installer
      get_url:
        url: "https://get.k3s.io"
        dest: "/tmp/k3s-install.sh"
        mode: '0755'

    - name: Install k3s server on additional masters
      shell: |
        K3S_TOKEN={{ hostvars[k3s_masters[0]]['k3s_node_token_value'] }} \
        K3S_KUBECONFIG_MODE="644" \
        K3S_URL="https://{{ hostvars[k3s_masters[0]]['ansible_host'] }}:6443" \
        /tmp/k3s-install.sh server \
        {{ k3s_server_args }}
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version if k3s_version != 'latest' else '' }}"
        INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
      become: yes
      retries: 3
      delay: 10

    - name: Wait for k3s server to be ready
      wait_for:
        path: "/etc/rancher/k3s/k3s.yaml"
        timeout: 120

  when:
    - inventory_hostname in groups['k3s_cluster']
    - inventory_hostname != k3s_masters[0]
    - 'node-.*-1$' | regex_search(inventory_hostname)

- name: Bootstrap k3s on worker nodes
  block:
    - name: Download k3s installer
      get_url:
        url: "https://get.k3s.io"
        dest: "/tmp/k3s-install.sh"
        mode: '0755'

    - name: Install k3s agent on workers
      shell: |
        K3S_TOKEN={{ hostvars[k3s_masters[0]]['k3s_node_token_value'] }} \
        K3S_URL="https://{{ hostvars[k3s_masters[0]]['ansible_host'] }}:6443" \
        /tmp/k3s-install.sh agent \
        {{ k3s_agent_args }}
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version if k3s_version != 'latest' else '' }}"
        INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
      become: yes
      retries: 3
      delay: 10

  when:
    - inventory_hostname in groups['k3s_cluster']
    - inventory_hostname not in k3s_masters

- name: Verify k3s cluster
  block:
    - name: Get cluster nodes
      shell: |
        kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      register: k3s_nodes

    - name: Display cluster nodes
      debug:
        msg: "{{ k3s_nodes.stdout }}"

  when: inventory_hostname == k3s_masters[0]

- name: Deploy optional components
  include_tasks: deploy_addition_components.yml
  when: inventory_hostname == k3s_masters[0]
