- name: Deploy ArgoCD
  block:
    - name: Add ArgoCD Helm repository
      shell: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: Create argocd namespace
      shell: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: Install ArgoCD
      shell: |
        helm install argocd argo/argo-cd \
          --namespace argocd \
          --set configs.secret.argocdServerAdminPassword="" \
          --set server.extraArgs[0]="--insecure" \
          --wait
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      retries: 3
      delay: 10

    - name: Wait for ArgoCD server to be ready
      shell: |
        kubectl wait --for=condition=Ready pod \
          -l app.kubernetes.io/name=argocd-server \
          -n argocd \
          --timeout=300s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      ignore_errors: yes

    - name: Retrieve ArgoCD admin password
      shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      register: argocd_password
      ignore_errors: yes

    - name: Display ArgoCD access information
      debug:
        msg: |
          ArgoCD deployed successfully!
          
          Access ArgoCD:
          - Port-forward: kubectl port-forward svc/argocd-server -n argocd 8080:443
          - URL: https://localhost:8080
          - Username: admin
          - Password: {{ argocd_password.stdout }}
          
          Or setup an Ingress for external access.

  when: enable_argocd | default(false)

