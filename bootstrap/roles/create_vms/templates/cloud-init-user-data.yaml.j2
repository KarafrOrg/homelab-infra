#cloud-config
hostname: {{ vm_base_name }}-{{ inventory_hostname }}-{{ item }}
fqdn: {{ vm_base_name }}-{{ inventory_hostname }}-{{ item }}.local

# Simple network configuration - ensure DHCP on eth0
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: true
      optional: true

# Update system packages
package_upgrade: true

# Install required packages
packages:
  - curl
  - wget
  - git
  - openssh-server
  - openssh-client
  - net-tools
  - htop
  - vim
  - sudo

# Enable SSH
ssh_enabled: true

# Create ubuntu user with sudo access
system_info:
  default_user:
    name: ubuntu
    home: /home/ubuntu
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups:
      - adm
      - audio
      - cdrom
      - dialout
      - dip
      - floppy
      - lxd
      - netdev
      - plugdev
      - sudo
      - video

# Run commands on first boot
runcmd:
  - echo "Cloud-init starting..." > /tmp/cloudinit.log
  - systemctl restart networking || systemctl restart systemd-networkd
  - echo "Networking restarted" >> /tmp/cloudinit.log
  - ip addr show >> /tmp/cloudinit.log
  - sleep 5
  - dhclient eth0 || true
  - echo "DHCP attempted" >> /tmp/cloudinit.log
  - ip addr show >> /tmp/cloudinit.log
  - apt-get update
  - apt-get install -y ca-certificates curl
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io
  - echo "Cloud-init completed" >> /tmp/cloudinit.log

final_message: "The system is up, after $UPTIME seconds"
