name: Bootstrap k3s Cluster

concurrency:
  group: create-vms-and-bootstrap-k3s-${{ github.ref }}
  cancel-in-progress: true

run-name: Bootstrap k3s Cluster

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ansible.cfg
      - inventory.yml
      - .github/workflows/bootstrap_k3s.yml
jobs:
  bootstap-cluster:
    uses: run_ansible_playbook.yml
    with:
      playbook_file: k3s.orchestration.site
      additional_args: >
        ansible_user_public_key="${{ vars.ANSIBLE_USER_PUBLIC_KEY }}"
        vms_per_host="${{ inputs.vms_per_host }}"
        k3s_version="${{ inputs.k3s_version }}"
      # language=bash
      pre_run_script: |
        ansible-galaxy collection install git+https://github.com/k3s-io/k3s-ansible.git
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_HOSTS: ${{ secrets.SERVER_HOSTS }}
      SSH_USER: ${{ secrets.SSH_USER }}

  install-argo-cd:
    needs: bootstap-cluster
    uses: run_ansible_playbook.yml
    with:
      playbook_file: playbooks/install_argocd.yml
      additional_args: >
        ansible_user_public_key="${{ vars.ANSIBLE_USER_PUBLIC_KEY }}"
      # language=bash
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_HOSTS: ${{ secrets.SERVER_HOSTS }}
      SSH_USER: ${{ secrets.SSH_USER }}
